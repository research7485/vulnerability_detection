import csv
import os
import google.generativeai as genai
import sys
import time
import random
import descriptions_with_ids

def read_functions(file):
    row = []
    with open(file, 'r') as f:
        reader = csv.DictReader(f)
        for x in reader:
            row.append(x)
    return row

data = read_functions('dfBigVulFinal.csv') # Is a list of dictionaries
length_of_data = len(data)  # length of list. i.e. length of rows
id_descriptions = descriptions_with_ids.mitre_descriptions # This is reference to the list of dictionaries object in descriptions.py

def main():
    print(len(data))
    genai.configure(api_key=os.environ['API_KEY'])
    model = genai.GenerativeModel('gemini-pro')
    
    with open('output/1_out.csv', 'w') as f:
        writer = csv.DictWriter(f, fieldnames=['Index', 'CWE', 'func', 'Vulnerable', 'Palm_Output', 'Prompt'])
        writer.writeheader()
        
    
         # For each cwe
        request_count = 0
        start_time = time.time()
        for x in range(len(data)):
            
    
            # get cwe and folder for the current row
            CWE = data[x]['CWE ID']
            Index = data[x]['\ufeffIdx']
            func = data[x]['func']
            Vulnerable = data[x]['target']
        
            
            # Check if 90 requests have been sent in the current minute
            if request_count >= 85:
                # Wait until the next minute starts
                current_time = time.time()
                time_to_sleep = 60 - (current_time - start_time)
                # Ensure time_to_sleep is non-negative
                if time_to_sleep < 0:
                    time_to_sleep = 0
                time.sleep(time_to_sleep)

                # Reset the request count and start time
                request_count = 0
                start_time = time.time()
            
            try:
                random_cwe, random_desc = random_false_cwe_gen(CWE)
                question = "The following function is being analyzed for potential vulnerabilities. Can you identify if it's vulnerable to the Common Weakness Enumeration (CWE) " + random_cwe + ' with description: "' + random_desc + '" or any other CWEs?'
                
                prompt =  question + " Here is the function: " + func
                
                #print(prompt)
                
                response = response = model.generate_content(prompt)
                record = {'CWE': CWE,
                        'Index': Index,
                        'func': func,
                        'Vulnerable': Vulnerable,
                        'Palm_Output': response.text,
                        'Prompt': prompt}
                writer.writerow(record)
            except Exception as e:
                log(f"Skipping Index {Index} and {CWE} due to error: {e}")
              

# input CWE e.g. CWE-89
def random_false_cwe_gen(actual_cwe): 
    random_number = random.randrange(0, length_of_data - 1)

    while True:
    
        cwe_id = data[random_number]['CWE ID'].strip()
        
        # Check cwe_id
        if cwe_id == '':
            random_number = random.randrange(0, length_of_data - 1)
            continue
        
        cwe_desc = cwe_to_desc(cwe_id)
        
        
        if cwe_desc is not None and actual_cwe != cwe_id:
            break 
        
        random_number = random.randrange(0, length_of_data - 1)
      
    
    return cwe_id, cwe_desc
    
def cwe_to_desc(cwe_id):
    print(cwe_id)
    _, id = cwe_id.split('-')
    for x in range(len(id_descriptions)):
        if id_descriptions[x]['id'] == id:
            return id_descriptions[x]['description']
    

        
def log(message):
    with open('failures.txt', 'a') as f:
        f.write(message + '\n')
        print(message)
    
if __name__ == "__main__":
    main()
    #print(random_false_cwe_gen('CWE-89'))
    
    
    
#question = "The following function is being analyzed for potential vulnerabilities. Can you identify if it's vulnerable to the Common Weakness Enumeration (CWE) " + random_cwe + ' with description: "' + random_desc + '" or any other CWEs?'
                
#                prompt =  question + " Here is the function: " + func